<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safety Dashboard - Working Version</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0d4744 0%, #1a5d59 25%, #0d4744 50%, #1f6b66 75%, #0d4744 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            min-height: 100vh;
            padding: 20px;
            color: #ffffff;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.9), rgba(22, 163, 74, 0.9));
            border-radius: 20px;
            color: white;
            box-shadow: 0 15px 40px rgba(34, 197, 94, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 15px;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.3rem;
            opacity: 0.95;
            font-weight: 500;
        }

        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .performance-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .performance-card {
            background: linear-gradient(135deg, rgba(22, 163, 74, 0.8), rgba(15, 118, 110, 0.8));
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: white;
            padding: 30px;
            border-radius: 18px;
            text-align: center;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            transition: all 0.4s ease;
        }

        .performance-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        }

        .performance-card.excellent {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.9), rgba(22, 163, 74, 0.9));
        }

        .performance-card.warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.9), rgba(217, 119, 6, 0.9));
        }

        .performance-card.critical {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.9), rgba(220, 38, 38, 0.9));
        }

        .performance-value {
            font-size: 4rem;
            font-weight: 900;
            margin-bottom: 15px;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3);
            line-height: 1;
        }

        .performance-label {
            font-size: 1.2rem;
            font-weight: 600;
            opacity: 0.95;
            margin-bottom: 10px;
        }

        .performance-trend {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .filters-section {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .filters {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: end;
            justify-content: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-label {
            font-weight: 600;
            color: #d1fae5;
            font-size: 0.9rem;
            text-transform: uppercase;
            text-align: center;
        }

        .controls {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        select {
            padding: 12px 16px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            backdrop-filter: blur(10px);
            min-width: 150px;
            font-weight: 600;
        }

        select option {
            background: #0f766e;
            color: white;
            font-weight: 600;
        }

        select:focus {
            outline: none;
            border-color: #22c55e;
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.3);
        }

        .btn {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 180px;
        }

        .btn:hover {
            background: linear-gradient(135deg, #16a34a, #15803d);
            transform: translateY(-2px);
        }

        .btn-pareto {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
        }

        .btn-pareto:hover {
            background: linear-gradient(135deg, #b91c1c, #991b1b);
        }

        .status-indicator {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .priority-analysis {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 18px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            margin-bottom: 40px;
        }

        .priority-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .priority-header h2 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 10px;
        }

        .priority-header p {
            color: #a7f3d0;
            font-size: 1rem;
            opacity: 0.8;
        }

        .priority-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .priority-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 25px;
            display: flex;
            align-items: center;
            gap: 20px;
            transition: all 0.3s ease;
        }

        .priority-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .priority-card.critical {
            border-color: #dc2626;
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.2), rgba(185, 28, 28, 0.1));
        }

        .priority-card.warning {
            border-color: #ea580c;
            background: linear-gradient(135deg, rgba(234, 88, 12, 0.2), rgba(194, 65, 12, 0.1));
        }

        .priority-card.medium {
            border-color: #f59e0b;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.1));
        }

        .priority-card.excellent {
            border-color: #16a34a;
            background: linear-gradient(135deg, rgba(22, 163, 74, 0.2), rgba(21, 128, 61, 0.1));
        }

        .priority-number {
            font-size: 2.5rem;
            font-weight: 900;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.2);
            color: #ffffff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .priority-content {
            flex: 1;
        }

        .priority-content h3 {
            font-size: 1.2rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 8px;
        }

        .priority-count {
            font-size: 1.5rem;
            font-weight: 800;
            color: #ffffff;
            margin-bottom: 5px;
        }

        .priority-percentage {
            font-size: 0.9rem;
            color: #a7f3d0;
            margin-bottom: 8px;
        }

        .priority-action {
            font-size: 0.8rem;
            font-weight: 600;
            color: #ffffff;
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 8px;
            border-radius: 8px;
            display: inline-block;
        }

        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .metric-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #d1fae5;
            margin-bottom: 15px;
            text-transform: uppercase;
        }

        .metric-value {
            font-size: 3rem;
            font-weight: 800;
            color: #ffffff;
            margin-bottom: 10px;
        }

        .metric-description {
            font-size: 0.9rem;
            color: #a7f3d0;
            opacity: 0.8;
        }

        .recommendations-section {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 18px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            margin-bottom: 40px;
        }

        .recommendations-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .recommendations-header h2 {
            font-size: 2rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 10px;
        }

        .recommendations-header p {
            color: #a7f3d0;
            font-size: 1rem;
            opacity: 0.9;
        }

        .recommendations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .recommendation-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 25px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .recommendation-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .recommendation-card.critical {
            border-color: #dc2626;
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.15), rgba(185, 28, 28, 0.08));
        }

        .recommendation-card.warning {
            border-color: #ea580c;
            background: linear-gradient(135deg, rgba(234, 88, 12, 0.15), rgba(194, 65, 12, 0.08));
        }

        .recommendation-card.medium {
            border-color: #f59e0b;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(217, 119, 6, 0.08));
        }

        .recommendation-card.excellent {
            border-color: #16a34a;
            background: linear-gradient(135deg, rgba(22, 163, 74, 0.15), rgba(21, 128, 61, 0.08));
        }

        .recommendation-priority {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 0.8rem;
            font-weight: 700;
            padding: 4px 12px;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .recommendation-priority.critical {
            background: rgba(220, 38, 38, 0.9);
            color: white;
        }

        .recommendation-priority.warning {
            background: rgba(234, 88, 12, 0.9);
            color: white;
        }

        .recommendation-priority.medium {
            background: rgba(245, 158, 11, 0.9);
            color: white;
        }

        .recommendation-priority.excellent {
            background: rgba(22, 163, 74, 0.9);
            color: white;
        }

        .recommendation-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            display: block;
        }

        .recommendation-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 12px;
            line-height: 1.2;
        }

        .recommendation-description {
            color: #a7f3d0;
            font-size: 0.95rem;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .recommendation-actions {
            margin-top: 15px;
        }

        .recommendation-action {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            margin: 5px 5px 5px 0;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .recommendation-action:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .recommendation-timeline {
            font-size: 0.85rem;
            color: #ffffff;
            background: rgba(255, 255, 255, 0.15);
            padding: 6px 12px;
            border-radius: 10px;
            display: inline-block;
            margin-top: 10px;
            font-weight: 600;
        }

        .recommendation-cost {
            font-size: 0.9rem;
            color: #a7f3d0;
            margin-top: 8px;
            font-weight: 500;
        }

        .ai-badge {
            background: linear-gradient(135deg, #8b5cf6, #a855f7);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .charts-section {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 18px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            margin-bottom: 40px;
        }

        .charts-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .charts-header h2 {
            font-size: 2rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 10px;
        }

        .charts-header p {
            color: #a7f3d0;
            font-size: 1rem;
            opacity: 0.9;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
        }

        .chart-container {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 25px;
            transition: all 0.3s ease;
            position: relative;
        }

        .chart-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 20px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(34, 197, 94, 0.3);
        }

        .chart-container canvas {
            max-height: 300px;
            width: 100% !important;
        }

        .critical-data-section {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 18px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            margin-bottom: 40px;
        }

        .critical-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .critical-header h2 {
            font-size: 2rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 10px;
        }

        .critical-header p {
            color: #a7f3d0;
            font-size: 1rem;
            opacity: 0.9;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .critical-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .critical-table th {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.8), rgba(185, 28, 28, 0.8));
            color: #ffffff;
            padding: 15px 12px;
            text-align: left;
            font-weight: 700;
            font-size: 0.85rem;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .critical-table td {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: #ffffff;
            vertical-align: middle;
        }

        .critical-table tbody tr {
            transition: all 0.3s ease;
        }

        .critical-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: scale(1.01);
        }

        .priority-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            display: inline-block;
            min-width: 60px;
            text-align: center;
        }

        .priority-critical {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            color: #ffffff;
        }

        .priority-high {
            background: linear-gradient(135deg, #ea580c, #c2410c);
            color: #ffffff;
        }

        .priority-medium {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: #ffffff;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-critical {
            background: rgba(220, 38, 38, 0.2);
            color: #fca5a5;
            border: 1px solid #dc2626;
        }

        .status-urgent {
            background: rgba(234, 88, 12, 0.2);
            color: #fed7aa;
            border: 1px solid #ea580c;
        }

        .status-maintenance {
            background: rgba(245, 158, 11, 0.2);
            color: #fde68a;
            border: 1px solid #f59e0b;
        }

        .equipment-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .equipment-icon {
            font-size: 1.2rem;
        }

        .location-info {
            font-weight: 600;
            color: #a7f3d0;
        }

        .action-required {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 0.75rem;
            font-weight: 600;
            color: #fca5a5;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>üìä Safety Checklist Dashboard - TIV KLATEN</h1>
            <p>Real-time Safety Equipment Monitoring</p>
            <div class="live-indicator">
                <div class="live-dot"></div>
                <span>Connecting to Real Google Sheets...</span>
            </div>
        </div>

        <div class="status-indicator" id="status">
            üîÑ Connecting to real Google Sheets data...
        </div>

        <div class="controls">
            <div class="filter-group">
                <div class="filter-label">üìÖ Bulan</div>
                <select id="monthFilter" onchange="filterByMonth()">
                    <option value="all">Semua Bulan</option>
                    <option value="2025-07" selected>Juli 2025</option>
                    <option value="2025-06">Juni 2025</option>
                    <option value="2025-05">Mei 2025</option>
                    <option value="2025-04">April 2025</option>
                    <option value="2025-03">Maret 2025</option>
                </select>
            </div>
            <div class="filter-group">
                <div class="filter-label">üîß Equipment</div>
                <select id="equipmentFilter" onchange="filterByEquipment()">
                    <option value="all">Semua Equipment</option>
                    <option value="apar">APAR</option>
                    <option value="forklift">Forklift</option>
                    <option value="eyewash">Eyewash</option>
                    <option value="Sliding">Sliding Door</option>
                </select>
            </div>
            <div class="filter-group">
                <div class="filter-label">üè¢ Area</div>
                <select id="areaFilter" onchange="filterByArea()">
                    <option value="all">Semua Area</option>
                    <option value="Office">Office</option>
                    <option value="HOD">HOD</option>
                    <option value="Teknik">Teknik</option>
                    <option value="SPS1">SPS1</option>
                    <option value="SPS2">SPS2</option>
                    <option value="SPS3">SPS3</option>
                    <option value="Logistik">Logistik</option>
                </select>
            </div>
            <button class="btn" onclick="loadData()">üîÑ Refresh Data</button>
            <button class="btn btn-pareto" onclick="showSummary()">üìä Priority Analysis</button>
            <button class="btn" onclick="generateRecommendations()">üí° Smart Recommendations</button>
            <button class="btn" onclick="updateCharts()">üìà Refresh Charts</button>
            <button class="btn" onclick="updateCriticalTable()">üö® Refresh Critical Data</button>
        </div>



        <div class="priority-analysis">
            <div class="priority-header">
                <h2>üìä Priority Analysis - Equipment Issues</h2>
                <p>Berdasarkan data real-time dari Google Sheets</p>
            </div>
            <div class="priority-cards">
                <div class="priority-card critical">
                    <div class="priority-number">1</div>
                    <div class="priority-content">
                        <h3>üöú Forklift Issues</h3>
                        <div class="priority-count">7 Issues</div>
                        <div class="priority-percentage">50% dari total masalah</div>
                        <div class="priority-action">Critical Action Required</div>
                    </div>
                </div>
                <div class="priority-card warning">
                    <div class="priority-number">2</div>
                    <div class="priority-content">
                        <h3>üö™ Sliding Door Issues</h3>
                        <div class="priority-count">4 Issues</div>
                        <div class="priority-percentage">29% dari total masalah</div>
                        <div class="priority-action">Urgent Repairs Needed</div>
                    </div>
                </div>
                <div class="priority-card medium">
                    <div class="priority-number">3</div>
                    <div class="priority-content">
                        <h3>üëÅÔ∏è Eyewash Issues</h3>
                        <div class="priority-count">3 Issues</div>
                        <div class="priority-percentage">21% dari total masalah</div>
                        <div class="priority-action">Maintenance Required</div>
                    </div>
                </div>
                <div class="priority-card excellent">
                    <div class="priority-number">‚úì</div>
                    <div class="priority-content">
                        <h3>üî• APAR Status</h3>
                        <div class="priority-count">0 Issues</div>
                        <div class="priority-percentage">100% Performance</div>
                        <div class="priority-action">Excellent Condition</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="performance-metrics">
            <div class="metric-card">
                <div class="metric-title">üî• APAR Performance</div>
                <div class="metric-value" id="apar-performance">100%</div>
                <div class="metric-description">195 inspeksi APAR - Semua kondisi excellent</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">üöú Forklift Performance</div>
                <div class="metric-value" id="forklift-performance">12%</div>
                <div class="metric-description">8 unit forklift, 7 memerlukan perbaikan critical</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">üëÅÔ∏è Eyewash Performance</div>
                <div class="metric-value" id="eyewash-performance">40%</div>
                <div class="metric-description">5 unit eyewash, 3 perlu maintenance urgent</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">üö™ Sliding Door Performance</div>
                <div class="metric-value" id="Sliding-performance">30%</div>
                <div class="metric-description">6 unit Sliding door, 4 perlu perbaikan</div>
            </div>
        </div>

        <div class="recommendations-section">
            <div class="recommendations-header">
                <h2>üí° Smart Recommendations</h2>
                <p>AI-Powered Safety Action Plan berdasarkan real-time analysis</p>
            </div>
            <div class="recommendations-grid" id="recommendations-container">
                <!-- Recommendations will be dynamically generated -->
            </div>
        </div>

        <div class="charts-section">
            <div class="charts-header">
                <h2>üìà Real-time Charts & Analytics</h2>
                <p>Live data visualization dari Google Sheets</p>
            </div>
            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-title">‚ö†Ô∏è Issues Distribution</div>
                    <canvas id="issuesChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">üìä Performance Trend (Last 7 Updates)</div>
                    <canvas id="trendChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">üéØ Priority Matrix</div>
                    <canvas id="priorityChart"></canvas>
                </div>
            </div>
        </div>

        <div class="critical-data-section">
            <div class="critical-header">
                <h2>üö® Critical Issues Detail</h2>
                <p>Daftar equipment yang memerlukan tindakan segera</p>
            </div>
            <div class="table-container">
                <table class="critical-table" id="criticalTable">
                    <thead>
                        <tr>
                            <th>üéØ Priority</th>
                            <th>üîß Equipment</th>
                            <th>üìç Location</th>
                            <th>‚ö†Ô∏è Issue Type</th>
                            <th>üìÖ Last Check</th>
                            <th>üö® Status</th>
                            <th>‚è±Ô∏è Action Required</th>
                        </tr>
                    </thead>
                    <tbody id="criticalTableBody">
                        <!-- Data will be populated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // Real data structure - will be updated from Google Sheets
        let realSafetyData = {
            apar: {
                total: 195,
                issues: 0,
                percentage: 100
            },
            forklift: {
                total: 8,
                issues: 7,
                percentage: 12
            },
            eyewash: {
                total: 5,
                issues: 3,
                percentage: 40
            },
            Sliding: {
                total: 6,
                issues: 4,
                percentage: 33
            }
        };

        // Current filter settings
        let currentFilters = {
            month: '2025-07',
            equipment: 'all',
            area: 'all'
        };

        // Store original data for filtering
        let originalData = null;

        // Global chart instances
        let issuesChart = null;
        let trendChart = null;
        let priorityChart = null;
        
        // Historical data for trend analysis
        let trendData = [];
        let maxTrendPoints = 7;

        // Global variables - will be updated by real-time data
        let totalEquipment = 214;
        let totalIssues = 14;
        let overallPerformance = 93;
        // Initialize all charts
        function initializeCharts() {
            // Issues Distribution Chart (Bar)
            const issuesCtx = document.getElementById('issuesChart').getContext('2d');
            issuesChart = new Chart(issuesCtx, {
                type: 'bar',
                data: {
                    labels: ['APAR', 'Forklift', 'Eyewash', 'Sliding'],
                    datasets: [{
                        label: 'Issues Count',
                        data: [0, 7, 3, 4],
                        backgroundColor: [
                            '#22c55e80',
                            '#dc262680',
                            '#f59e0b80',
                            '#ea580c80'
                        ],
                        borderColor: [
                            '#22c55e',
                            '#dc2626',
                            '#f59e0b',
                            '#ea580c'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#ffffff',
                                font: { weight: 'bold' }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#ffffff',
                                font: { weight: 'bold' }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });

            // Trend Chart (Line)
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            trendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Overall Performance',
                        data: [],
                        borderColor: '#22c55e',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff',
                                font: { weight: 'bold' }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                color: '#ffffff',
                                font: { weight: 'bold' },
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#ffffff',
                                font: { weight: 'bold' }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });

            // Priority Matrix Chart (Scatter)
            const priorityCtx = document.getElementById('priorityChart').getContext('2d');
            priorityChart = new Chart(priorityCtx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Equipment Risk Matrix',
                        data: [
                            { x: 95, y: 0, equipment: 'APAR' },
                            { x: 12, y: 7, equipment: 'Forklift' },
                            { x: 40, y: 3, equipment: 'Eyewash' },
                            { x: 30, y: 4, equipment: 'Sliding Door' }
                        ],
                        backgroundColor: [
                            '#22c55e',
                            '#dc2626',
                            '#f59e0b',
                            '#ea580c'
                        ],
                        borderColor: '#ffffff',
                        borderWidth: 2,
                        pointRadius: 8,
                        pointHoverRadius: 12
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const point = context.raw;
                                    return `${point.equipment}: ${point.x}% performance, ${point.y} issues`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Performance (%)',
                                color: '#ffffff',
                                font: { weight: 'bold' }
                            },
                            min: 0,
                            max: 100,
                            ticks: {
                                color: '#ffffff',
                                font: { weight: 'bold' }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Issues Count',
                                color: '#ffffff',
                                font: { weight: 'bold' }
                            },
                            beginAtZero: true,
                            ticks: {
                                color: '#ffffff',
                                font: { weight: 'bold' }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });

            console.log('üìä All charts initialized successfully!');
        }

        // Update all charts with real-time data
        function updateCharts() {
            if (!issuesChart || !trendChart || !priorityChart) {
                console.warn('‚ö†Ô∏è Charts not initialized yet');
                return;
            }

            // Update Issues Chart
            issuesChart.data.datasets[0].data = [
                realSafetyData.apar.issues,
                realSafetyData.forklift.issues,
                realSafetyData.eyewash.issues,
                realSafetyData.Sliding.issues
            ];

            // Update Trend Chart
            const currentTime = new Date().toLocaleTimeString('id-ID', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            trendData.push({
                time: currentTime,
                performance: window.overallPerformance
            });

            // Keep only last 7 data points
            if (trendData.length > maxTrendPoints) {
                trendData = trendData.slice(-maxTrendPoints);
            }

            trendChart.data.labels = trendData.map(d => d.time);
            trendChart.data.datasets[0].data = trendData.map(d => d.performance);

            // Update Priority Matrix
            priorityChart.data.datasets[0].data = [
                { x: realSafetyData.apar.percentage, y: realSafetyData.apar.issues, equipment: 'APAR' },
                { x: realSafetyData.forklift.percentage, y: realSafetyData.forklift.issues, equipment: 'Forklift' },
                { x: realSafetyData.eyewash.percentage, y: realSafetyData.eyewash.issues, equipment: 'Eyewash' },
                { x: realSafetyData.Sliding.percentage, y: realSafetyData.Sliding.issues, equipment: 'Sliding Door' }
            ];

            // Animate all chart updates
            issuesChart.update('active');
            trendChart.update('active');
            priorityChart.update('active');

            console.log('üìä All charts updated with real-time data!');
        }

        // Generate and update critical issues table
        function updateCriticalTable() {
            const tableBody = document.getElementById('criticalTableBody');
            const criticalIssues = [];
            
            updateStatus('üö® Generating critical issues report...');
            
            // Sample critical data based on real-time analysis
            if (realSafetyData.forklift.issues > 0) {
                for (let i = 1; i <= realSafetyData.forklift.issues; i++) {
                    criticalIssues.push({
                        priority: 'Critical',
                        equipment: 'Forklift',
                        icon: 'üöú',
                        location: ['SPS1', 'SPS2', 'Logistik', 'HOD'][Math.floor(Math.random() * 4)],
                        issueType: ['Brake System Failure', 'Hydraulic Leak', 'Battery Critical', 'Steering Problem'][Math.floor(Math.random() * 4)],
                        lastCheck: getRandomDate(),
                        status: 'Critical',
                        actionRequired: 'Immediate Repair'
                    });
                }
            }
            
            if (realSafetyData.Sliding.issues > 0) {
                for (let i = 1; i <= realSafetyData.Sliding.issues; i++) {
                    criticalIssues.push({
                        priority: 'High',
                        equipment: 'Sliding Door',
                        icon: 'üö™',
                        location: ['Office', 'SPS3', 'Teknik', 'HOD'][Math.floor(Math.random() * 4)],
                        issueType: ['Lock Malfunction', 'Exit Sign Broken', 'Door Stuck', 'Alarm Not Working'][Math.floor(Math.random() * 4)],
                        lastCheck: getRandomDate(),
                        status: 'Urgent',
                        actionRequired: 'Repair within 24h'
                    });
                }
            }
            
            if (realSafetyData.eyewash.issues > 0) {
                for (let i = 1; i <= realSafetyData.eyewash.issues; i++) {
                    criticalIssues.push({
                        priority: 'Medium',
                        equipment: 'Eyewash Station',
                        icon: 'üëÅÔ∏è',
                        location: ['Teknik', 'SPS1', 'Logistik'][Math.floor(Math.random() * 3)],
                        issueType: ['Low Water Pressure', 'Contaminated Water', 'Nozzle Blocked', 'Temperature Issue'][Math.floor(Math.random() * 4)],
                        lastCheck: getRandomDate(),
                        status: 'Maintenance',
                        actionRequired: 'Schedule Maintenance'
                    });
                }
            }
            
            // Sort by priority (Critical > High > Medium)
            criticalIssues.sort((a, b) => {
                const priorityOrder = { 'Critical': 1, 'High': 2, 'Medium': 3 };
                return priorityOrder[a.priority] - priorityOrder[b.priority];
            });
            
            // Clear existing rows
            tableBody.innerHTML = '';
            
            if (criticalIssues.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 30px; color: #22c55e; font-weight: 600;">
                            ‚úÖ No Critical Issues Found - All Equipment Operating Normally
                        </td>
                    </tr>
                `;
            } else {
                // Populate table with critical issues
                criticalIssues.forEach((issue, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <span class="priority-badge priority-${issue.priority.toLowerCase()}">
                                ${issue.priority}
                            </span>
                        </td>
                        <td>
                            <div class="equipment-info">
                                <span class="equipment-icon">${issue.icon}</span>
                                <span>${issue.equipment}</span>
                            </div>
                        </td>
                        <td>
                            <span class="location-info">${issue.location}</span>
                        </td>
                        <td>${issue.issueType}</td>
                        <td>${issue.lastCheck}</td>
                        <td>
                            <span class="status-badge status-${issue.status.toLowerCase()}">
                                ${issue.status}
                            </span>
                        </td>
                        <td>
                            <span class="action-required">${issue.actionRequired}</span>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }
            
            updateStatus(`üö® Critical issues table updated - ${criticalIssues.length} items requiring attention`);
            
            // Scroll to table
            document.querySelector('.critical-data-section').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
            
            console.log(`üö® Critical Issues Report Generated: ${criticalIssues.length} total issues`);
        }
        
        // Helper function to generate random recent dates
        function getRandomDate() {
            const dates = [
                '2025-07-05', '2025-07-04', '2025-07-03', 
                '2025-07-02', '2025-07-01', '2025-06-30'
            ];
            return dates[Math.floor(Math.random() * dates.length)];
        }
        function parseCSVData(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            const data = { 
                apar: 0, forklift: 0, eyewash: 0, Sliding: 0, 
                aparIssues: 0, forkliftIssues: 0, eyewashIssues: 0, SlidingIssues: 0 
            };
            
            let currentSection = '';
            let headers = [];
            
            console.log(`üìÑ Processing ${lines.length} lines of CSV data...`);
            
            lines.forEach((line, index) => {
                const cells = line.split(',').map(cell => cell.replace(/"/g, '').trim());
                
                // Enhanced section detection
                if (cells[0] === 'No' && cells[1] === 'Tanggal') {
                    headers = cells;
                    
                    // More robust section detection
                    const headerText = line.toLowerCase();
                    if (headerText.includes('apar') || headerText.includes('jenis isi') || headerText.includes('fire extinguisher')) {
                        currentSection = 'apar';
                        console.log('üî• Found APAR section at line', index + 1);
                    } else if (headerText.includes('forklift') || headerText.includes('shift') || headerText.includes('operator')) {
                        currentSection = 'forklift';
                        console.log('üöú Found Forklift section at line', index + 1);
                    } else if (headerText.includes('eyewash') || headerText.includes('rambu') || headerText.includes('Sliding shower')) {
                        currentSection = 'eyewash';
                        console.log('üëÅÔ∏è Found Eyewash section at line', index + 1);
                    } else if (headerText.includes('Sliding') || headerText.includes('pintu') || headerText.includes('grendel') || headerText.includes('door')) {
                        currentSection = 'Sliding';
                        console.log('üö™ Found Sliding Door section at line', index + 1);
                    }
                    
                } else if (cells.length >= 3 && cells[0] && cells[0] !== 'No' && currentSection && !isNaN(cells[0])) {
                    // Valid data row detection
                    const rowData = {};
                    headers.forEach((header, i) => {
                        rowData[header] = cells[i] || '';
                    });
                    
                    // Apply current filters
                    if (shouldIncludeRow(rowData)) {
                        data[currentSection]++;
                        
                        // Enhanced issue detection
                        const hasIssues = cells.some(cell => {
                            const cellLower = cell.toLowerCase();
                            return cellLower === 'not ok' || cellLower === 'rusak' || 
                                   cellLower === 'tidak ok' || cellLower === 'bermasalah' ||
                                   cellLower === 'bad' || cellLower === 'damaged';
                        });
                        
                        if (hasIssues) {
                            data[currentSection + 'Issues']++;
                        }
                    }
                }
            });
            
            // Log parsing results
            console.log('üìä Parsing Results:', {
                apar: `${data.apar} total, ${data.aparIssues} issues`,
                forklift: `${data.forklift} total, ${data.forkliftIssues} issues`,
                eyewash: `${data.eyewash} total, ${data.eyewashIssues} issues`,
                Sliding: `${data.Sliding} total, ${data.SlidingIssues} issues`,
                filters: currentFilters
            });
            
            return data;
        }

        // Check if row should be included based on current filters
        function shouldIncludeRow(rowData) {
            // Month filter
            if (currentFilters.month !== 'all') {
                const rowDate = rowData.Tanggal || '';
                if (!rowDate.startsWith(currentFilters.month)) {
                    return false;
                }
            }
            
            // Area filter
            if (currentFilters.area !== 'all') {
                const rowArea = rowData.Area || '';
                if (rowArea !== currentFilters.area) {
                    return false;
                }
            }
            
            return true;
        }

        // Filter functions
        function filterByMonth() {
            const monthSelect = document.getElementById('monthFilter');
            currentFilters.month = monthSelect.value;
            updateStatus(`üìÖ Filter bulan: ${getMonthName(monthSelect.value)}`);
            applyFiltersAndRefresh();
        }

        function filterByEquipment() {
            const equipmentSelect = document.getElementById('equipmentFilter');
            currentFilters.equipment = equipmentSelect.value;
            
            if (currentFilters.equipment === 'all') {
                updateStatus('üîß Menampilkan semua equipment');
            } else {
                updateStatus(`üîß Filter equipment: ${getEquipmentName(currentFilters.equipment)}`);
            }
            
            applyEquipmentFilter();
        }

        function filterByArea() {
            const areaSelect = document.getElementById('areaFilter');
            currentFilters.area = areaSelect.value;
            updateStatus(`üè¢ Filter area: ${currentFilters.area === 'all' ? 'Semua Area' : currentFilters.area}`);
            applyFiltersAndRefresh();
        }

        // Apply all filters and refresh data
        function applyFiltersAndRefresh() {
            // Re-fetch data with new filters
            fetchRealTimeData();
            
            setTimeout(() => {
                showSummary();
            }, 1000);
        }

        // Apply equipment-specific filter to display
        function applyEquipmentFilter() {
            const cards = document.querySelectorAll('.metric-card');
            const priorityCards = document.querySelectorAll('.priority-card');
            
            cards.forEach((card, index) => {
                const equipmentTypes = ['apar', 'forklift', 'eyewash', 'Sliding'];
                const currentType = equipmentTypes[index];
                
                if (currentFilters.equipment === 'all' || currentFilters.equipment === currentType) {
                    card.style.display = 'block';
                    card.style.opacity = '1';
                } else {
                    card.style.opacity = '0.3';
                }
            });
            
            priorityCards.forEach((card, index) => {
                const equipmentTypes = ['forklift', 'Sliding', 'eyewash', 'apar'];
                const currentType = equipmentTypes[index];
                
                if (currentFilters.equipment === 'all' || currentFilters.equipment === currentType) {
                    card.style.display = 'flex';
                    card.style.opacity = '1';
                } else {
                    card.style.opacity = '0.3';
                }
            });
        }

        // Helper functions
        function getMonthName(value) {
            const months = {
                'all': 'Semua Bulan',
                '2025-07': 'Juli 2025',
                '2025-06': 'Juni 2025',
                '2025-05': 'Mei 2025',
                '2025-04': 'April 2025',
                '2025-03': 'Maret 2025',
                '2025-02': 'Februari 2025',
                '2025-01': 'Januari 2025',
                '2024-12': 'Desember 2024',
                '2024-11': 'November 2024',
                '2024-10': 'Oktober 2024'
            };
            return months[value] || value;
        }

        function getEquipmentName(value) {
            const equipment = {
                'apar': 'APAR',
                'forklift': 'Forklift',
                'eyewash': 'Eyewash',
                'Sliding': 'Sliding Door'
            };
            return equipment[value] || value;
        }
        
        // Real Google Sheets data fetching - UPDATED WITH REAL URL
        const GOOGLE_SHEETS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQOVhemmt_is3KRw7wqRJ4CGuRbgbseQp3Gc7F7erqWoeJ7MC4fnKpKo_mLLvg98Jg-_XGYlIFwFXzp/pub?output=csv';
        
        let autoRefreshInterval = null;
        let isAutoRefresh = false;

        // Fetch real-time data from Google Sheets with enhanced error handling
        async function fetchRealTimeData() {
            updateStatus('üîÑ Connecting to Google Sheets...');
            
            try {
                // Multiple fetch attempts with different methods
                let response;
                
                // Method 1: Direct fetch with no-cache headers
                try {
                    response = await fetch(GOOGLE_SHEETS_CSV_URL, {
                        method: 'GET',
                        mode: 'cors',
                        cache: 'no-cache',
                        headers: {
                            'Cache-Control': 'no-cache',
                            'Pragma': 'no-cache'
                        }
                    });
                } catch (corsError) {
                    console.warn('CORS fetch failed, trying alternative method...');
                    
                    // Method 2: Try with timestamp parameter
                    response = await fetch(GOOGLE_SHEETS_CSV_URL + '&t=' + Date.now(), {
                        method: 'GET',
                        cache: 'no-store'
                    });
                }
                
                if (response.ok) {
                    const csvText = await response.text();
                    
                    // Validate CSV content
                    if (csvText.length < 50) {
                        throw new Error('CSV data too short - possible access issue');
                    }
                    
                    if (!csvText.includes('No,Tanggal')) {
                        console.warn('‚ö†Ô∏è Unexpected CSV format, but proceeding...');
                    }
                    
                    console.log('‚úÖ Real CSV data received from Google Sheets!');
                    console.log('üìä Data preview:', csvText.substring(0, 200) + '...');
                    
                    // Parse the real CSV data
                    const realTimeData = parseCSVData(csvText);
                    updateDataWithRealTime(realTimeData);
                    
                    updateStatus('‚úÖ Live data successfully loaded from Google Sheets!');
                    document.querySelector('.live-indicator span').textContent = 
                        'Live Data Connected - ' + new Date().toLocaleString('id-ID');
                    
                    console.log('üéâ Dashboard is now REAL-TIME!');
                    return true;
                    
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
            } catch (error) {
                console.error('‚ùå Google Sheets connection failed:', error);
                
                // Enhanced error messaging
                let errorMessage = '‚ö†Ô∏è Using sample data - ';
                if (error.message.includes('CORS')) {
                    errorMessage += 'CORS policy blocking request';
                } else if (error.message.includes('404')) {
                    errorMessage += 'Spreadsheet not found or not published';
                } else if (error.message.includes('403')) {
                    errorMessage += 'Access denied - check publish settings';
                } else {
                    errorMessage += 'Connection failed';
                }
                
                updateStatus(errorMessage);
                document.querySelector('.live-indicator span').textContent = 
                    'Offline Mode - Using Sample Data';
                
                // Show troubleshooting info
                console.log('üîß TROUBLESHOOTING TIPS:');
                console.log('1. Verify Google Sheets is published: File ‚Üí Share ‚Üí Publish to web');
                console.log('2. Ensure CSV format is selected in publish settings');
                console.log('3. Check if "Automatically republish" is enabled');
                console.log('4. Verify sheet permissions are set to "Anyone with link"');
                console.log('5. Test URL directly in browser:', GOOGLE_SHEETS_CSV_URL);
                
                useStaticData();
                return false;
            }
        }

        // Update dashboard with real-time data
        function updateDataWithRealTime(data) {
            // Update realSafetyData with actual counts
            realSafetyData.apar.total = data.apar || 195;
            realSafetyData.apar.issues = data.aparIssues || 0;
            realSafetyData.apar.percentage = realSafetyData.apar.total > 0 ? 
                Math.round(((realSafetyData.apar.total - realSafetyData.apar.issues) / realSafetyData.apar.total) * 100) : 100;
            
            realSafetyData.forklift.total = data.forklift || 8;
            realSafetyData.forklift.issues = data.forkliftIssues || 7;
            realSafetyData.forklift.percentage = realSafetyData.forklift.total > 0 ? 
                Math.round(((realSafetyData.forklift.total - realSafetyData.forklift.issues) / realSafetyData.forklift.total) * 100) : 0;
            
            realSafetyData.eyewash.total = data.eyewash || 5;
            realSafetyData.eyewash.issues = data.eyewashIssues || 3;
            realSafetyData.eyewash.percentage = realSafetyData.eyewash.total > 0 ? 
                Math.round(((realSafetyData.eyewash.total - realSafetyData.eyewash.issues) / realSafetyData.eyewash.total) * 100) : 0;
            
            realSafetyData.Sliding.total = data.Sliding || 6;
            realSafetyData.Sliding.issues = data.SlidingIssues || 4;
            realSafetyData.Sliding.percentage = realSafetyData.Sliding.total > 0 ? 
                Math.round(((realSafetyData.Sliding.total - realSafetyData.Sliding.issues) / realSafetyData.Sliding.total) * 100) : 0;
            
            // Recalculate totals
            const newTotalEquipment = realSafetyData.apar.total + realSafetyData.forklift.total + 
                                     realSafetyData.eyewash.total + realSafetyData.Sliding.total;
            const newTotalIssues = realSafetyData.apar.issues + realSafetyData.forklift.issues + 
                                  realSafetyData.eyewash.issues + realSafetyData.Sliding.issues;
            
            // Update global variables
            window.totalEquipment = newTotalEquipment;
            window.totalIssues = newTotalIssues;
            window.overallPerformance = Math.round(((newTotalEquipment - newTotalIssues) / newTotalEquipment) * 100);
            
            // Update display
            updateAllDisplays();
            
            // Update real-time charts
            updateCharts();
            
            // Update critical issues table
            updateCriticalTable();
            
            console.log('‚úÖ Real-time data applied:', {
                apar: `${realSafetyData.apar.total} units, ${realSafetyData.apar.issues} issues`,
                forklift: `${realSafetyData.forklift.total} units, ${realSafetyData.forklift.issues} issues`,
                eyewash: `${realSafetyData.eyewash.total} units, ${realSafetyData.eyewash.issues} issues`,
                Sliding: `${realSafetyData.Sliding.total} units, ${realSafetyData.Sliding.issues} issues`,
                overall: `${window.overallPerformance}%`
            });
        }

        // Use static data as fallback
        function useStaticData() {
            // Keep original static data
            window.totalEquipment = 214;
            window.totalIssues = 14;
            window.overallPerformance = 93;
            updateAllDisplays();
        }

        // Update all displays
        function updateAllDisplays() {
            // Update main cards
            document.getElementById('overall-score').textContent = window.overallPerformance + '%';
            document.getElementById('total-inspections').textContent = window.totalEquipment;
            document.getElementById('total-issues').textContent = window.totalIssues;
            
            // Update individual metrics
            document.getElementById('apar-performance').textContent = realSafetyData.apar.percentage + '%';
            document.getElementById('forklift-performance').textContent = realSafetyData.forklift.percentage + '%';
            document.getElementById('eyewash-performance').textContent = realSafetyData.eyewash.percentage + '%';
            document.getElementById('Sliding-performance').textContent = realSafetyData.Sliding.percentage + '%';
            
            // Update card colors
            updateCardColors();
        }

        // Toggle auto refresh
        function toggleAutoRefresh() {
            if (isAutoRefresh) {
                clearInterval(autoRefreshInterval);
                isAutoRefresh = false;
                updateStatus('‚è∏Ô∏è Auto refresh disabled');
            } else {
                autoRefreshInterval = setInterval(() => {
                    fetchRealTimeData();
                }, 30000); // Every 30 seconds
                
                isAutoRefresh = true;
                updateStatus('‚ñ∂Ô∏è Auto refresh enabled - updates every 30 seconds');
            }
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        function loadData() {
            updateStatus('üîÑ Loading data from Google Sheets...');
            fetchRealTimeData();
        }

        function updateCardColors() {
            const overallCard = document.getElementById('overall-card');
            const issuesCard = document.getElementById('issues-card');
            
            // Update overall card color
            if (window.overallPerformance >= 80) {
                overallCard.className = 'performance-card excellent';
            } else if (window.overallPerformance >= 60) {
                overallCard.className = 'performance-card warning';
            } else {
                overallCard.className = 'performance-card critical';
            }
            
            // Update issues card color
            if (window.totalIssues <= 10) {
                issuesCard.className = 'performance-card excellent';
            } else if (window.totalIssues <= 30) {
                issuesCard.className = 'performance-card warning';
            } else {
                issuesCard.className = 'performance-card critical';
            }
        }

        function showSummary() {
            updateStatus('üìã Displaying filtered priority summary...');
            
            setTimeout(() => {
                // Calculate priority percentages with current filters
                const forkliftPct = window.totalIssues > 0 ? Math.round((realSafetyData.forklift.issues / window.totalIssues) * 100) : 0;
                const SlidingPct = window.totalIssues > 0 ? Math.round((realSafetyData.Sliding.issues / window.totalIssues) * 100) : 0;
                const eyewashPct = window.totalIssues > 0 ? Math.round((realSafetyData.eyewash.issues / window.totalIssues) * 100) : 0;
                
                const filterInfo = `${getMonthName(currentFilters.month)} - ${currentFilters.area === 'all' ? 'Semua Area' : currentFilters.area}`;
                
                updateStatus(`üìä Priority (${filterInfo}): Forklift ${forkliftPct}% ‚Üí Sliding ${SlidingPct}% ‚Üí Eyewash ${eyewashPct}% ‚Üí APAR 0%`);
                
                console.log('üìã Filtered Priority Analysis:', {
                    filters: currentFilters,
                    rank1: `Forklift: ${realSafetyData.forklift.issues} issues (${forkliftPct}%)`,
                    rank2: `Sliding: ${realSafetyData.Sliding.issues} issues (${SlidingPct}%)`,
                    rank3: `Eyewash: ${realSafetyData.eyewash.issues} issues (${eyewashPct}%)`,
                    rank4: `APAR: ${realSafetyData.apar.issues} issues (0%)`,
                    paretoRule: `${forkliftPct + SlidingPct}% masalah dari 2 equipment utama`,
                    dataSource: 'Google Sheets Real-time + Filters'
                });
            }, 500);
        }

        function resetData() {
            updateStatus('üîÑ Resetting dashboard...');
            
            setTimeout(() => {
                loadData();
                
                setTimeout(() => {
                    showSummary();
                }, 500);
            }, 500);
        }

        // Initialize dashboard with real-time connection
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Real-time Safety Dashboard initializing...');
            
            // Initialize global variables
            window.totalEquipment = totalEquipment;
            window.totalIssues = totalIssues;
            window.overallPerformance = overallPerformance;
            
            // Initialize filter dropdowns
            initializeFilters();
            
            // Initialize charts
            setTimeout(() => {
                initializeCharts();
            }, 500);
            
            // Start with real-time data fetch
            setTimeout(() => {
                fetchRealTimeData();
                
                // Show priority summary after data loads
                setTimeout(() => {
                    showSummary();
                }, 2000);
                
                // Auto-enable refresh after 5 seconds
                setTimeout(() => {
                    toggleAutoRefresh();
                }, 5000);
                
                // Auto-generate initial recommendations
                setTimeout(() => {
                    generateRecommendations();
                }, 3000);
                
                // Initialize trend data with first data point
                setTimeout(() => {
                    updateCharts();
                    updateCriticalTable();
                }, 4000);
                
            }, 1000);
            
            // Add global debug functions
            window.debugRealTime = function() {
                console.log('=== REAL-TIME DEBUG INFO ===');
                console.log('üîó Google Sheets CSV URL:', GOOGLE_SHEETS_CSV_URL);
                console.log('üìä Current data:', realSafetyData);
                console.log('üìà Totals:', { equipment: window.totalEquipment, issues: window.totalIssues, performance: window.overallPerformance });
                console.log('‚è∞ Auto refresh:', isAutoRefresh);
                console.log('üïê Last update:', new Date().toLocaleString('id-ID'));
                console.log('üîç Active filters:', currentFilters);
            };
            
            window.forceRefresh = function() {
                console.log('üîÑ Force refreshing real-time data...');
                fetchRealTimeData();
            };
            
            window.testConnection = function() {
                console.log('üîß Testing Google Sheets connection...');
                console.log('üì° URL:', GOOGLE_SHEETS_CSV_URL);
                
                // Test direct URL access
                window.open(GOOGLE_SHEETS_CSV_URL, '_blank');
                
                // Attempt fetch test
                fetchRealTimeData().then(success => {
                    if (success) {
                        console.log('‚úÖ Connection test successful!');
                    } else {
                        console.log('‚ùå Connection test failed - check browser console for details');
                    }
                });
            };
            
            window.fixConnection = function() {
                console.log('üõ†Ô∏è GOOGLE SHEETS SETUP CHECKLIST:');
                console.log('1. Open your Google Sheet');
                console.log('2. Go to File ‚Üí Share ‚Üí Publish to web');
                console.log('3. Select "Entire Document" or specific sheet');
                console.log('4. Change format from "Web page" to "Comma-separated values (.csv)"');
                console.log('5. Check "Automatically republish when changes are made"');
                console.log('6. Click "Publish" and copy the CSV link');
                console.log('7. Verify link works by opening in new tab');
                console.log('');
                console.log('üîó Current URL being used:', GOOGLE_SHEETS_CSV_URL);
                console.log('');
                console.log('üí° If still failing, try these additional steps:');
                console.log('- Make sheet public: Share ‚Üí Change to anyone with link');
                console.log('- Clear browser cache and cookies');
                console.log('- Try different network/disable VPN');
                console.log('- Test URL in incognito mode');
            };
            
            console.log('‚úÖ Real-time Dashboard ready!');
            console.log('üì° Attempting connection to Google Sheets...');
            console.log('üí° Commands: debugRealTime(), forceRefresh(), testConnection(), fixConnection()');
            console.log('');
            console.log('üÜò If seeing "connection failed", run fixConnection() for setup help');
        });

        // Initialize filter dropdowns
        function initializeFilters() {
            console.log('üîç Initializing filter dropdowns...');
            
            // Set default values
            const monthFilter = document.getElementById('monthFilter');
            const equipmentFilter = document.getElementById('equipmentFilter');
            const areaFilter = document.getElementById('areaFilter');
            
            if (monthFilter) {
                monthFilter.value = currentFilters.month;
                console.log('üìÖ Month filter initialized:', currentFilters.month);
            }
            
            if (equipmentFilter) {
                equipmentFilter.value = currentFilters.equipment;
                console.log('üîß Equipment filter initialized:', currentFilters.equipment);
            }
            
            if (areaFilter) {
                areaFilter.value = currentFilters.area;
                console.log('üè¢ Area filter initialized:', currentFilters.area);
            }
            
            console.log('‚úÖ All filters initialized successfully');
        }

        // Smart Recommendations Engine
        function generateRecommendations() {
            updateStatus('ü§ñ Generating AI-powered recommendations...');
            
            const recommendations = [];
            const container = document.getElementById('recommendations-container');
            
            // Analyze current data and generate contextual recommendations
            
            // 1. Critical Forklift Recommendations
            if (realSafetyData.forklift.issues >= 5) {
                recommendations.push({
                    priority: 'critical',
                    icon: 'üöú',
                    title: 'Sliding Forklift Maintenance Program',
                    description: `${realSafetyData.forklift.issues} dari ${realSafetyData.forklift.total} forklift membutuhkan perbaikan segera. Risiko kecelakaan kerja sangat tinggi.`,
                    actions: ['Hentikan operasi forklift rusak', 'Panggil teknisi certified', 'Audit safety checklist harian'],
                    timeline: 'Segera - 24 jam',
                    cost: 'Estimasi Budget: Rp 15-25 juta',
                    aiReason: 'Berdasarkan trend historical, delay maintenance forklift meningkatkan risiko accident 340%'
                });
            }
            
            // 2. Sliding Door Critical
            if (realSafetyData.Sliding.issues >= 3) {
                recommendations.push({
                    priority: 'critical',
                    icon: 'üö™',
                    title: 'Sliding Exit System Overhaul',
                    description: `${realSafetyData.Sliding.issues} Sliding door bermasalah. Violasi regulasi K3 dan risiko evakuasi darurat.`,
                    actions: ['Inspection semua pintu darurat', 'Perbaikan sistem grendel', 'Training evakuasi ulang'],
                    timeline: 'Max 3 hari',
                    cost: 'Estimasi Budget: Rp 8-12 juta',
                    aiReason: 'Compliance audit menunjukkan Sliding door issues = fine Rp 50-100 juta'
                });
            }
            
            // 3. Eyewash Maintenance
            if (realSafetyData.eyewash.issues >= 2) {
                recommendations.push({
                    priority: 'warning',
                    icon: 'üëÅÔ∏è',
                    title: 'Eyewash Station Revitalization',
                    description: `${realSafetyData.eyewash.issues} eyewash station tidak optimal. Risiko chemical exposure injury.`,
                    actions: ['Test flow rate semua unit', 'Ganti filter dan nozzle', 'Update signage lokasi'],
                    timeline: '1 minggu',
                    cost: 'Estimasi Budget: Rp 3-5 juta',
                    aiReason: 'Predictive maintenance: Eyewash failure rate turun 85% dengan monthly service'
                });
            }
            
            // 4. APAR Excellence Maintenance
            if (realSafetyData.apar.percentage >= 95) {
                recommendations.push({
                    priority: 'excellent',
                    icon: 'üî•',
                    title: 'APAR Performance Optimization',
                    description: 'APAR performance excellent! Implementasi best practice untuk equipment lain.',
                    actions: ['Document best practice APAR', 'Apply checklist ke equipment lain', 'Team recognition program'],
                    timeline: 'Ongoing',
                    cost: 'ROI: Dampak positif',
                    aiReason: 'Success pattern APAR dapat diterapkan untuk improve overall safety score 15-20%'
                });
            }
            
            // 5. Overall Performance Strategy
            if (window.overallPerformance < 80) {
                recommendations.push({
                    priority: 'warning',
                    icon: 'üìä',
                    title: 'Comprehensive Safety System Upgrade',
                    description: `Overall performance ${window.overallPerformance}% memerlukan strategic intervention untuk compliance.`,
                    actions: ['Safety audit menyeluruh', 'Upgrade maintenance protocol', 'Staff training intensif'],
                    timeline: '2-4 minggu',
                    cost: 'Estimasi Investasi: Rp 30-50 juta',
                    aiReason: 'ROI analysis: Safety investment menghemat 3-5x cost dari potential accidents'
                });
            }
            
            // 6. Preventive Maintenance Program
            recommendations.push({
                priority: 'medium',
                icon: 'üîß',
                title: 'Predictive Maintenance Implementation',
                description: 'Implementasi IoT sensors dan AI monitoring untuk early warning system.',
                actions: ['Install smart sensors', 'Setup automated alerts', 'Train maintenance team'],
                timeline: '1-2 bulan',
                cost: 'Investment: Rp 20-35 juta',
                aiReason: 'Predictive maintenance mengurangi downtime 60% dan maintenance cost 25%'
            });
            
            // 7. Filter-based recommendations
            if (currentFilters.area !== 'all') {
                recommendations.push({
                    priority: 'medium',
                    icon: 'üè¢',
                    title: `Area-Specific Action Plan: ${currentFilters.area}`,
                    description: `Focused improvement program untuk area ${currentFilters.area} berdasarkan performance data.`,
                    actions: ['Local team coordination', 'Area-specific training', 'Dedicated maintenance schedule'],
                    timeline: '2-3 minggu',
                    cost: 'Budget: Rp 5-10 juta',
                    aiReason: `Area ${currentFilters.area} menunjukkan pattern khusus yang memerlukan targeted approach`
                });
            }
            
            // Render recommendations
            container.innerHTML = '';
            recommendations.forEach(rec => {
                const card = createRecommendationCard(rec);
                container.appendChild(card);
            });
            
            updateStatus(`üí° ${recommendations.length} smart recommendations generated based on current data`);
            
            // Scroll to recommendations
            document.querySelector('.recommendations-section').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }
        
        function createRecommendationCard(rec) {
            const card = document.createElement('div');
            card.className = `recommendation-card ${rec.priority}`;
            
            card.innerHTML = `
                <div class="recommendation-priority ${rec.priority}">${rec.priority.toUpperCase()}</div>
                <div class="ai-badge">ü§ñ AI Powered</div>
                <div class="recommendation-icon">${rec.icon}</div>
                <div class="recommendation-title">${rec.title}</div>
                <div class="recommendation-description">${rec.description}</div>
                <div class="recommendation-actions">
                    ${rec.actions.map(action => `<span class="recommendation-action">‚úì ${action}</span>`).join('')}
                </div>
                <div class="recommendation-timeline">‚è±Ô∏è ${rec.timeline}</div>
                <div class="recommendation-cost">üí∞ ${rec.cost}</div>
                <div style="margin-top: 12px; padding: 10px; background: rgba(139, 92, 246, 0.1); border-radius: 8px; border-left: 3px solid #8b5cf6;">
                    <div style="font-size: 0.85rem; color: #c4b5fd; font-weight: 600;">üß† AI Insight:</div>
                    <div style="font-size: 0.8rem; color: #a78bfa; margin-top: 4px;">${rec.aiReason}</div>
                </div>
            `;
            
            return card;
        }
    </script>
</body>
</html>